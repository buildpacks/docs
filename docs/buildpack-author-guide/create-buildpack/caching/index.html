<!doctype html>
<html lang="en">

<head>
  


<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="We can improve performance by caching dependencies between builds, only re-downloading when necessary. To begin, let&amp;rsquo;s create a cacheable bundler layer.
Creating the bundler layer To do this,…"/>
<link rel="canonical" content="https://buildpacks.io/docs/buildpack-author-guide/create-buildpack/caching/">
<link rel="icon" type="image/png" href="/images/favicon.png">






<meta property="og:title" content="Improving performance with caching · Cloud Native Buildpacks">
<meta property="og:type" content="website">
<meta property="og:url" content="https://buildpacks.io/docs/buildpack-author-guide/create-buildpack/caching/">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Cloud Native Buildpacks">
<meta property="og:description" content="We can improve performance by caching dependencies between builds, only re-downloading when necessary. To begin, let&amp;rsquo;s create a cacheable bundler layer.
Creating the bundler layer To do this,…">
<meta property="og:type" content="article">
<meta property="og:image" content="https://buildpacks.io/images/buildpacks-social-card.jpg">
<meta property="og:image:alt" content="Buildpacks project logo">
<meta property="og:image:type" content="image/jpeg">






<meta property="twitter:title" content="Improving performance with caching · Cloud Native Buildpacks">
<meta property="twitter:card" content="summary">
<meta property="twitter:image" content="https://buildpacks.io/images/buildpacks-social-card-square.jpg">
<meta property="twitter:image:alt" content="Buildpacks project logo">
<meta property="twitter:site" content="@buildpacks_io">
<meta property="twitter:creator" content="@buildpacks_io">

  <script
    src="https://cdn.jsdelivr.net/combine/npm/axios@0.21.0,npm/jquery@3.5.1,npm/bootstrap@4.5.3,npm/fullcalendar@5.4.0"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css"
    crossorigin="anonymous">
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/combine/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css,npm/fullcalendar@5.4.0/main.min.css"
    crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Source+Sans+Pro:400,400i,600" rel="stylesheet">
  
  <link rel="stylesheet" href="https://buildpacks.io/scss/site.css" integrity="" media="screen">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CJLSR4FQXL"></script>

  <script>
    $(function () {
      $('h1[id], h2[id], h3[id], h4[id], h5[id]').not(':has(a)').each(function () {
        this.innerHTML =
          `<a href="#${this.id}" class="h-anchor">
            ${this.innerHTML} <i class="fas fa-link icon" aria-label="Anchor"></i>
          </a>`;
      });

      if ($('input#search').length > 0) {
        docsearch({
          apiKey: '5c00a51f166dab99e1cc6e0a9976e9f9',
          indexName: 'buildpacks',
          inputSelector: 'input#search',
          debug: false
        });
      }
    });

    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-CJLSR4FQXL');
  </script>

  <title>Improving performance with caching · Cloud Native Buildpacks</title>
</head>

<body>
  <header class="container px-0">
  <nav class="navbar navbar-expand-lg navbar-light">
    <a href="https://buildpacks.io/" class="logo navbar-brand"><img src="/images/buildpacks-logo.svg"
        alt="Buildpacks Logo"></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
      <ul class="navbar-nav">
        
        
        
        <li class="nav-item mr-lg-4 text-center text-lg-left ">
          <a class="nav-link py-2 py-lg-0 px-1"  href="/features">
            Features
          </a>
        </li>
        
        
        <li class="nav-item mr-lg-4 text-center text-lg-left ">
          <a class="nav-link py-2 py-lg-0 px-1"  href="/community">
            Community
          </a>
        </li>
        
        
        <li class="nav-item mr-lg-4 text-center text-lg-left ">
          <a class="nav-link py-2 py-lg-0 px-1" target='_blank'  href="https://medium.com/buildpacks">
            Blog
          </a>
        </li>
        
        
        <li class="nav-item mr-lg-4 text-center text-lg-left ">
          <a class="nav-link py-2 py-lg-0 px-1" target='_blank'  href="https://registry.buildpacks.io/">
            Registry
          </a>
        </li>
        
        <li class="nav-item text-center d-lg-none">
          <a class="nav-link py-2 px-1" href="/docs">Docs</a>
        </li>
        <li class="nav-item text-center d-lg-none">
          <a class="nav-link py-2 px-1" target='_blank' rel="noopener noreferrer" href="https://github.com/buildpacks">GitHub</a>
        </li>
      </ul>

      <a class="button-light mr-3 d-none d-lg-block" href="/docs"><i class="far fa-file-alt mr-2"></i>Docs</a>
      <a class="github-button icon-button bg-blue button d-none d-lg-flex" href="https://github.com/buildpacks">GitHub</a>
    </div>
  </nav>
</header>

  

<div class='docs'>
  <div class="container">
    <div class='row'>
      <div class='col-md-3 docs-sidebar'>
        <nav class='sidebar'>
  <form class="pt-1 pb-3 pl-2 pr-3 border-bottom">
    <input id="search" class="form-control" type="search" placeholder="Search..." aria-label="Search">
  </form>
  <ul>
    <li data-nav-id="/docs/" class="dd-item depth-0">
      <a href="/docs/">Getting Started</a>
      <ul class="ml-2">
        
<li data-nav-id="/docs/app-journey/" class="dd-item depth-1 collapse">
  <a href="/docs/app-journey/">An App&rsquo;s Brief Journey from Source to Image</a>
</li>
      </ul>
    </li>
<li data-nav-id="/docs/concepts/" class="dd-item depth-0 haschildren">
  <a href="/docs/concepts/">Concepts</a>
  <ul class="ml-2">
<li data-nav-id="/docs/concepts/components/" class="dd-item depth-1 collapse haschildren">
  <a href="/docs/concepts/components/">Components</a>
  <ul class="ml-2">
<li data-nav-id="/docs/concepts/components/builder/" class="dd-item depth-2">
  <a href="/docs/concepts/components/builder/">Builder</a>
</li>
<li data-nav-id="/docs/concepts/components/buildpack/" class="dd-item depth-2">
  <a href="/docs/concepts/components/buildpack/">Buildpack</a>
</li>
<li data-nav-id="/docs/concepts/components/buildpack-group/" class="dd-item depth-2">
  <a href="/docs/concepts/components/buildpack-group/">Buildpack Group</a>
</li>
<li data-nav-id="/docs/concepts/components/lifecycle/" class="dd-item depth-2 haschildren">
  <a href="/docs/concepts/components/lifecycle/">Lifecycle</a>
  <ul class="ml-2">
<li data-nav-id="/docs/concepts/components/lifecycle/analyze/" class="dd-item depth-3 collapse">
  <a href="/docs/concepts/components/lifecycle/analyze/">Analyze</a>
</li>
<li data-nav-id="/docs/concepts/components/lifecycle/detect/" class="dd-item depth-3 collapse">
  <a href="/docs/concepts/components/lifecycle/detect/">Detect</a>
</li>
<li data-nav-id="/docs/concepts/components/lifecycle/restore/" class="dd-item depth-3 collapse">
  <a href="/docs/concepts/components/lifecycle/restore/">Restore</a>
</li>
<li data-nav-id="/docs/concepts/components/lifecycle/build/" class="dd-item depth-3 collapse">
  <a href="/docs/concepts/components/lifecycle/build/">Build</a>
</li>
<li data-nav-id="/docs/concepts/components/lifecycle/export/" class="dd-item depth-3 collapse">
  <a href="/docs/concepts/components/lifecycle/export/">Export</a>
</li>
<li data-nav-id="/docs/concepts/components/lifecycle/create/" class="dd-item depth-3 collapse">
  <a href="/docs/concepts/components/lifecycle/create/">Create</a>
</li>
<li data-nav-id="/docs/concepts/components/lifecycle/launch/" class="dd-item depth-3 collapse">
  <a href="/docs/concepts/components/lifecycle/launch/">Launch</a>
</li>
<li data-nav-id="/docs/concepts/components/lifecycle/rebase/" class="dd-item depth-3 collapse">
  <a href="/docs/concepts/components/lifecycle/rebase/">Rebase</a>
</li>
  </ul>
</li>
<li data-nav-id="/docs/concepts/components/platform/" class="dd-item depth-2">
  <a href="/docs/concepts/components/platform/">Platform</a>
</li>
<li data-nav-id="/docs/concepts/components/stack/" class="dd-item depth-2">
  <a href="/docs/concepts/components/stack/">Stack</a>
</li>
  </ul>
</li>
<li data-nav-id="/docs/concepts/operations/" class="dd-item depth-1 collapse haschildren">
  <a href="/docs/concepts/operations/">Operations</a>
  <ul class="ml-2">
<li data-nav-id="/docs/concepts/operations/build/" class="dd-item depth-2">
  <a href="/docs/concepts/operations/build/">Build</a>
</li>
<li data-nav-id="/docs/concepts/operations/rebase/" class="dd-item depth-2">
  <a href="/docs/concepts/operations/rebase/">Rebase</a>
</li>
  </ul>
</li>
  </ul>
</li>
<li data-nav-id="/docs/features/" class="dd-item depth-0 haschildren">
  <a href="/docs/features/">Features</a>
  <ul class="ml-2">
<li data-nav-id="/docs/features/bill-of-materials/" class="dd-item depth-1 collapse">
  <a href="/docs/features/bill-of-materials/">Bill of Materials</a>
</li>
<li data-nav-id="/docs/features/reproducibility/" class="dd-item depth-1 collapse">
  <a href="/docs/features/reproducibility/">Reproducibility</a>
</li>
  </ul>
</li>
<li data-nav-id="/docs/app-developer-guide/" class="dd-item depth-0 haschildren">
  <a href="/docs/app-developer-guide/">App Developer Guide</a>
  <ul class="ml-2">
<li data-nav-id="/docs/app-developer-guide/build-an-app/" class="dd-item depth-1">
  <a href="/docs/app-developer-guide/build-an-app/">Build an app</a>
</li>
<li data-nav-id="/docs/app-developer-guide/build-a-windows-app/" class="dd-item depth-1">
  <a href="/docs/app-developer-guide/build-a-windows-app/">Build a Windows app</a>
</li>
<li data-nav-id="/docs/app-developer-guide/build-an-arm-app/" class="dd-item depth-1">
  <a href="/docs/app-developer-guide/build-an-arm-app/">Build an ARM app</a>
</li>
<li data-nav-id="/docs/app-developer-guide/environment-variables/" class="dd-item depth-1">
  <a href="/docs/app-developer-guide/environment-variables/">Environment variables</a>
</li>
<li data-nav-id="/docs/app-developer-guide/using-cache-image/" class="dd-item depth-1">
  <a href="/docs/app-developer-guide/using-cache-image/">Cache Images</a>
</li>
<li data-nav-id="/docs/app-developer-guide/mounting-volumes/" class="dd-item depth-1">
  <a href="/docs/app-developer-guide/mounting-volumes/">Mounting Volumes</a>
</li>
<li data-nav-id="/docs/app-developer-guide/specify-buildpacks/" class="dd-item depth-1">
  <a href="/docs/app-developer-guide/specify-buildpacks/">Specify buildpacks</a>
</li>
<li data-nav-id="/docs/app-developer-guide/run-an-app/" class="dd-item depth-1">
  <a href="/docs/app-developer-guide/run-an-app/">Specify launch process</a>
</li>
<li data-nav-id="/docs/app-developer-guide/using-project-descriptor/" class="dd-item depth-1">
  <a href="/docs/app-developer-guide/using-project-descriptor/">Using project.toml</a>
</li>
<li data-nav-id="/docs/app-developer-guide/using-inline-buildpacks/" class="dd-item depth-1">
  <a href="/docs/app-developer-guide/using-inline-buildpacks/">Using Inline Buildpacks</a>
</li>
<li data-nav-id="/docs/app-developer-guide/using-http-proxy/" class="dd-item depth-1">
  <a href="/docs/app-developer-guide/using-http-proxy/">Using Buildpacks with a Proxy</a>
</li>
  </ul>
</li>
<li data-nav-id="/docs/buildpack-author-guide/" class="dd-item depth-0 parent haschildren">
  <a href="/docs/buildpack-author-guide/">Buildpack Author Guide</a>
  <ul class="ml-2">
<li data-nav-id="/docs/buildpack-author-guide/create-buildpack/" class="dd-item depth-1 parent haschildren">
  <a href="/docs/buildpack-author-guide/create-buildpack/">Create a buildpack</a>
  <ul class="ml-2">
<li data-nav-id="/docs/buildpack-author-guide/create-buildpack/setup-local-environment/" class="dd-item depth-2">
  <a href="/docs/buildpack-author-guide/create-buildpack/setup-local-environment/">Set up your local environment</a>
</li>
<li data-nav-id="/docs/buildpack-author-guide/create-buildpack/building-blocks-cnb/" class="dd-item depth-2">
  <a href="/docs/buildpack-author-guide/create-buildpack/building-blocks-cnb/">Building blocks of a Cloud Native Buildpack</a>
</li>
<li data-nav-id="/docs/buildpack-author-guide/create-buildpack/detection/" class="dd-item depth-2">
  <a href="/docs/buildpack-author-guide/create-buildpack/detection/">Detecting your application</a>
</li>
<li data-nav-id="/docs/buildpack-author-guide/create-buildpack/build-app/" class="dd-item depth-2">
  <a href="/docs/buildpack-author-guide/create-buildpack/build-app/">Building your application</a>
</li>
<li data-nav-id="/docs/buildpack-author-guide/create-buildpack/make-app-runnable/" class="dd-item depth-2">
  <a href="/docs/buildpack-author-guide/create-buildpack/make-app-runnable/">Make your application runnable</a>
</li>
<li data-nav-id="/docs/buildpack-author-guide/create-buildpack/specify-multiple-process-types/" class="dd-item depth-2">
  <a href="/docs/buildpack-author-guide/create-buildpack/specify-multiple-process-types/">Specify multiple process types</a>
</li>
<li data-nav-id="/docs/buildpack-author-guide/create-buildpack/caching/" class="dd-item depth-2 active">
  <a href="/docs/buildpack-author-guide/create-buildpack/caching/">Improving performance with caching</a>
</li>
<li data-nav-id="/docs/buildpack-author-guide/create-buildpack/make-buildpack-configurable/" class="dd-item depth-2">
  <a href="/docs/buildpack-author-guide/create-buildpack/make-buildpack-configurable/">Making your buildpack configurable</a>
</li>
<li data-nav-id="/docs/buildpack-author-guide/create-buildpack/adding-bill-of-materials/" class="dd-item depth-2">
  <a href="/docs/buildpack-author-guide/create-buildpack/adding-bill-of-materials/">Adding Bill-of-Materials</a>
</li>
  </ul>
</li>
<li data-nav-id="/docs/buildpack-author-guide/package-a-buildpack/" class="dd-item depth-1">
  <a href="/docs/buildpack-author-guide/package-a-buildpack/">Package a buildpack</a>
</li>
<li data-nav-id="/docs/buildpack-author-guide/publish-a-buildpack/" class="dd-item depth-1">
  <a href="/docs/buildpack-author-guide/publish-a-buildpack/">Publish a buildpack</a>
</li>
<li data-nav-id="/docs/buildpack-author-guide/publishing-with-github-actions/" class="dd-item depth-1">
  <a href="/docs/buildpack-author-guide/publishing-with-github-actions/">Publishing with Github Actions</a>
</li>
  </ul>
</li>
<li data-nav-id="/docs/operator-guide/" class="dd-item depth-0 haschildren">
  <a href="/docs/operator-guide/">Operator Guide</a>
  <ul class="ml-2">
<li data-nav-id="/docs/operator-guide/create-a-builder/" class="dd-item depth-1">
  <a href="/docs/operator-guide/create-a-builder/">Create a builder</a>
</li>
<li data-nav-id="/docs/operator-guide/create-a-stack/" class="dd-item depth-1">
  <a href="/docs/operator-guide/create-a-stack/">Create a stack</a>
</li>
  </ul>
</li>
<li data-nav-id="/docs/platform-guide/" class="dd-item depth-0 haschildren">
  <a href="/docs/platform-guide/">Platform Guide</a>
  <ul class="ml-2">
<li data-nav-id="/docs/platform-guide/conventions/" class="dd-item depth-1 haschildren">
  <a href="/docs/platform-guide/conventions/">Conventions</a>
  <ul class="ml-2">
<li data-nav-id="/docs/platform-guide/conventions/source-metadata/" class="dd-item depth-2 collapse">
  <a href="/docs/platform-guide/conventions/source-metadata/">Source Metadata</a>
</li>
  </ul>
</li>
  </ul>
</li>
<li data-nav-id="/docs/tools/" class="dd-item depth-0 haschildren">
  <a href="/docs/tools/">Tools</a>
  <ul class="ml-2">
<li data-nav-id="/docs/tools/pack/" class="dd-item depth-1 haschildren">
  <a href="/docs/tools/pack/">Pack</a>
  <ul class="ml-2">
<li data-nav-id="/docs/tools/pack/concepts/" class="dd-item depth-2 collapse haschildren">
  <a href="/docs/tools/pack/concepts/">Concepts</a>
  <ul class="ml-2">
<li data-nav-id="/docs/tools/pack/concepts/trusted_builders/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/concepts/trusted_builders/">Trusted Builders</a>
</li>
  </ul>
</li>
<li data-nav-id="/docs/tools/pack/cli/" class="dd-item depth-2 collapse haschildren">
  <a href="/docs/tools/pack/cli/">CLI Docs</a>
  <ul class="ml-2">
<li data-nav-id="/docs/tools/pack/cli/pack/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack/">pack</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_build/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_build/">pack build</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_builder/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_builder/">pack builder</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_builder_create/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_builder_create/">pack builder create</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_builder_inspect/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_builder_inspect/">pack builder inspect</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_builder_suggest/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_builder_suggest/">pack builder suggest</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_buildpack/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_buildpack/">pack buildpack</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_buildpack_inspect/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_buildpack_inspect/">pack buildpack inspect</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_buildpack_new/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_buildpack_new/">pack buildpack new</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_buildpack_package/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_buildpack_package/">pack buildpack package</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_buildpack_pull/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_buildpack_pull/">pack buildpack pull</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_buildpack_register/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_buildpack_register/">pack buildpack register</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_buildpack_yank/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_buildpack_yank/">pack buildpack yank</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_completion/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_completion/">pack completion</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config/">pack config</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_default-builder/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_default-builder/">pack config default-builder</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_experimental/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_experimental/">pack config experimental</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_lifecycle-image/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_lifecycle-image/">pack config lifecycle-image</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_pull-policy/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_pull-policy/">pack config pull-policy</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_registries/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_registries/">pack config registries</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_registries_add/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_registries_add/">pack config registries add</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_registries_default/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_registries_default/">pack config registries default</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_registries_list/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_registries_list/">pack config registries list</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_registries_remove/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_registries_remove/">pack config registries remove</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_registry-mirrors/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_registry-mirrors/">pack config registry-mirrors</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_registry-mirrors_add/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_registry-mirrors_add/">pack config registry-mirrors add</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_registry-mirrors_list/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_registry-mirrors_list/">pack config registry-mirrors list</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_registry-mirrors_remove/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_registry-mirrors_remove/">pack config registry-mirrors remove</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_run-image-mirrors/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_run-image-mirrors/">pack config run-image-mirrors</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_run-image-mirrors_add/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_run-image-mirrors_add/">pack config run-image-mirrors add</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_run-image-mirrors_list/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_run-image-mirrors_list/">pack config run-image-mirrors list</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_run-image-mirrors_remove/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_run-image-mirrors_remove/">pack config run-image-mirrors remove</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_trusted-builders/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_trusted-builders/">pack config trusted-builders</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_trusted-builders_add/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_trusted-builders_add/">pack config trusted-builders add</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_trusted-builders_list/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_trusted-builders_list/">pack config trusted-builders list</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_config_trusted-builders_remove/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_config_trusted-builders_remove/">pack config trusted-builders remove</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_inspect/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_inspect/">pack inspect</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_rebase/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_rebase/">pack rebase</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_report/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_report/">pack report</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_stack/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_stack/">pack stack</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_stack_suggest/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_stack_suggest/">pack stack suggest</a>
</li>
<li data-nav-id="/docs/tools/pack/cli/pack_version/" class="dd-item depth-3 collapse">
  <a href="/docs/tools/pack/cli/pack_version/">pack version</a>
</li>
  </ul>
</li>
  </ul>
</li>
<li data-nav-id="/docs/tools/circleci/" class="dd-item depth-1">
  <a href="/docs/tools/circleci/">CircleCI</a>
</li>
<li data-nav-id="/docs/tools/gitlab/" class="dd-item depth-1">
  <a href="/docs/tools/gitlab/">Gitlab Auto DevOps</a>
</li>
<li data-nav-id="/docs/tools/kpack/" class="dd-item depth-1">
  <a href="/docs/tools/kpack/">kpack</a>
</li>
<li data-nav-id="/docs/tools/tekton/" class="dd-item depth-1">
  <a href="/docs/tools/tekton/">Tekton</a>
</li>
  </ul>
</li>
<li data-nav-id="/docs/reference/" class="dd-item depth-0 haschildren">
  <a href="/docs/reference/">Reference</a>
  <ul class="ml-2">
<li data-nav-id="/docs/reference/config/" class="dd-item depth-1 collapse haschildren">
  <a href="/docs/reference/config/">Configuration</a>
  <ul class="ml-2">
<li data-nav-id="/docs/reference/config/builder-config/" class="dd-item depth-2 collapse">
  <a href="/docs/reference/config/builder-config/">builder.toml</a>
</li>
<li data-nav-id="/docs/reference/config/package-config/" class="dd-item depth-2 collapse">
  <a href="/docs/reference/config/package-config/">package.toml</a>
</li>
<li data-nav-id="/docs/reference/config/project-descriptor/" class="dd-item depth-2 collapse">
  <a href="/docs/reference/config/project-descriptor/">project.toml</a>
</li>
  </ul>
</li>
<li data-nav-id="/docs/reference/spec/" class="dd-item depth-1 collapse haschildren">
  <a href="/docs/reference/spec/">Specification</a>
  <ul class="ml-2">
<li data-nav-id="/docs/reference/spec/buildpack-api/" class="dd-item depth-2">
  <a href="/docs/reference/spec/buildpack-api/">Buildpack API</a>
</li>
<li data-nav-id="/docs/reference/spec/distribution-api/" class="dd-item depth-2">
  <a href="/docs/reference/spec/distribution-api/">Distribution API</a>
</li>
<li data-nav-id="/docs/reference/spec/migration/" class="dd-item depth-2 haschildren">
  <a href="/docs/reference/spec/migration/">Migration</a>
  <ul class="ml-2">
<li data-nav-id="/docs/reference/spec/migration/buildpack-api-0.4-0.5/" class="dd-item depth-3 collapse">
  <a href="/docs/reference/spec/migration/buildpack-api-0.4-0.5/">Buildpack API 0.4 -&gt; 0.5</a>
</li>
<li data-nav-id="/docs/reference/spec/migration/buildpack-api-0.5-0.6/" class="dd-item depth-3 collapse">
  <a href="/docs/reference/spec/migration/buildpack-api-0.5-0.6/">Buildpack API 0.5 -&gt; 0.6</a>
</li>
<li data-nav-id="/docs/reference/spec/migration/buildpack-api-0.6-0.7/" class="dd-item depth-3 collapse">
  <a href="/docs/reference/spec/migration/buildpack-api-0.6-0.7/">Buildpack API 0.6 -&gt; 0.7</a>
</li>
<li data-nav-id="/docs/reference/spec/migration/platform-api-0.3-0.4/" class="dd-item depth-3 collapse">
  <a href="/docs/reference/spec/migration/platform-api-0.3-0.4/">Platform API 0.3 -&gt; 0.4</a>
</li>
<li data-nav-id="/docs/reference/spec/migration/platform-api-0.4-0.5/" class="dd-item depth-3 collapse">
  <a href="/docs/reference/spec/migration/platform-api-0.4-0.5/">Platform API 0.4 -&gt; 0.5</a>
</li>
<li data-nav-id="/docs/reference/spec/migration/platform-api-0.5-0.6/" class="dd-item depth-3 collapse">
  <a href="/docs/reference/spec/migration/platform-api-0.5-0.6/">Platform API 0.5 -&gt; 0.6</a>
</li>
<li data-nav-id="/docs/reference/spec/migration/platform-api-0.6-0.7/" class="dd-item depth-3 collapse">
  <a href="/docs/reference/spec/migration/platform-api-0.6-0.7/">Platform API 0.6 -&gt; 0.7</a>
</li>
<li data-nav-id="/docs/reference/spec/migration/platform-api-0.7-0.8/" class="dd-item depth-3 collapse">
  <a href="/docs/reference/spec/migration/platform-api-0.7-0.8/">Platform API 0.7 -&gt; 0.8</a>
</li>
  </ul>
</li>
<li data-nav-id="/docs/reference/spec/platform-api/" class="dd-item depth-2">
  <a href="/docs/reference/spec/platform-api/">Platform API</a>
</li>
  </ul>
</li>
  </ul>
</li>
  </ul>
  
</nav>



      </div>
      <div class='col-md-9 docs-content'>
        <div class="support-links text-right">
  
    
    
    <a href="https://github.com/buildpacks/docs/issues/new?body=%2A%2AOn&#43;Page%3A%2A%2A&#43;%5BImproving&#43;performance&#43;with&#43;caching%5D%28https%3A%2F%2Fbuildpacks.io%2Fdocs%2Fbuildpack-author-guide%2Fcreate-buildpack%2Fcaching%2F%29"
       class="button-light button-small icon-button blank bg-white inline-flex" target="_blank">Report Issue</a>

    
    
    <a href="https://github.com/buildpacks/docs/edit/main/content/docs/buildpack-author-guide/create-buildpack/caching.md?description=Signed-off-by%3A&#43;NAME&#43;%3CEMAIL_ADDRESS%3E%0A%0A%3E&#43;_By&#43;signing&#43;off&#43;you&#43;acknowledge&#43;adhering&#43;to&#43;the&#43;requirements&#43;listed&#43;here%3A&#43;https%3A%2F%2Fprobot.github.io%2Fapps%2Fdco%2F_"
       class="button-light button-small icon-button github-button bg-white inline-flex" target="_blank">Edit</a>
    
  
</div>


        <div class="heading">
          <h1 class="title">Improving performance with caching</h1>
        </div>

        <!-- test:suite=create-buildpack;weight=7 -->
<p>We can improve performance by caching dependencies between builds, only re-downloading when necessary. To begin, let&rsquo;s create a cacheable <code>bundler</code> layer.</p>
<h2 id="creating-the-bundler-layer">Creating the <code>bundler</code> layer</h2>
<p>To do this, replace the following lines in the <code>build</code> script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="s2">&#34;---&gt; Installing gems&#34;</span>
bundle install
</code></pre></div><p>with the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="s2">&#34;---&gt; Installing gems&#34;</span>
<span class="nv">bundlerlayer</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler&#34;</span>
mkdir -p <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span>
<span class="nb">echo</span> -e <span class="s1">&#39;[types]\ncache = true\nlaunch = true&#39;</span> &gt; <span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler.toml&#34;</span>
bundle config <span class="nb">set</span> --local path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> bundle install <span class="o">&amp;&amp;</span> bundle binstubs --all --path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">/bin&#34;</span>

</code></pre></div><p>Your full <code>ruby-buildpack/bin/build</code> script should now look like the following:</p>
<!-- test:file=ruby-buildpack/bin/build -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/usr/bin/env bash
</span><span class="cp"></span><span class="nb">set</span> -eo pipefail

<span class="nb">echo</span> <span class="s2">&#34;---&gt; Ruby Buildpack&#34;</span>

<span class="c1"># 1. GET ARGS</span>
<span class="nv">layersdir</span><span class="o">=</span><span class="nv">$1</span>

<span class="c1"># 2. CREATE THE LAYER DIRECTORY</span>
<span class="nv">rubylayer</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">&#34;</span>/ruby
mkdir -p <span class="s2">&#34;</span><span class="nv">$rubylayer</span><span class="s2">&#34;</span>

<span class="c1"># 3. DOWNLOAD RUBY</span>
<span class="nb">echo</span> <span class="s2">&#34;---&gt; Downloading and extracting Ruby&#34;</span>
<span class="nv">ruby_url</span><span class="o">=</span>https://s3-external-1.amazonaws.com/heroku-buildpack-ruby/heroku-18/ruby-2.5.1.tgz
wget -q -O - <span class="s2">&#34;</span><span class="nv">$ruby_url</span><span class="s2">&#34;</span> <span class="p">|</span> tar -xzf - -C <span class="s2">&#34;</span><span class="nv">$rubylayer</span><span class="s2">&#34;</span>

<span class="c1"># 4. MAKE RUBY AVAILABLE DURING LAUNCH</span>
<span class="nb">echo</span> -e <span class="s1">&#39;[types]\nlaunch = true&#39;</span> &gt; <span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/ruby.toml&#34;</span>

<span class="c1"># 5. MAKE RUBY AVAILABLE TO THIS SCRIPT</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$rubylayer</span><span class="s2">&#34;</span>/bin:<span class="nv">$PATH</span>
<span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">LD_LIBRARY_PATH</span><span class="p">:+</span><span class="si">${</span><span class="nv">LD_LIBRARY_PATH</span><span class="si">}</span><span class="p">:</span><span class="si">}</span><span class="s2">&#34;</span><span class="nv">$rubylayer</span><span class="s2">/lib&#34;</span>

<span class="c1"># 6. INSTALL BUNDLER</span>
<span class="nb">echo</span> <span class="s2">&#34;---&gt; Installing bundler&#34;</span>
gem install bundler --no-ri --no-rdoc

<span class="c1"># ======= MODIFIED =======</span>
<span class="c1"># 7. INSTALL GEMS</span>
<span class="nb">echo</span> <span class="s2">&#34;---&gt; Installing gems&#34;</span>
<span class="nv">bundlerlayer</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler&#34;</span>
mkdir -p <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span>
<span class="nb">echo</span> -e <span class="s1">&#39;[types]\ncache = true\nlaunch = true&#39;</span> &gt; <span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler.toml&#34;</span>
bundle config <span class="nb">set</span> --local path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> bundle install <span class="o">&amp;&amp;</span> bundle binstubs --all --path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">/bin&#34;</span>

<span class="c1"># 8. SET DEFAULT START COMMAND</span>
cat &gt; <span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/launch.toml&#34;</span> <span class="s">&lt;&lt;EOL
</span><span class="s"># our web process
</span><span class="s">[[processes]]
</span><span class="s">type = &#34;web&#34;
</span><span class="s">command = &#34;bundle exec ruby app.rb&#34;
</span><span class="s">default = true
</span><span class="s">
</span><span class="s"># our worker process
</span><span class="s">[[processes]]
</span><span class="s">type = &#34;worker&#34;
</span><span class="s">command = &#34;bundle exec ruby worker.rb&#34;
</span><span class="s">EOL</span>
</code></pre></div><p>Now when we run:</p>
<!-- test:exec -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">pack build test-ruby-app --path ./ruby-sample-app --buildpack ./ruby-buildpack
</code></pre></div><p>You will see something similar to the following during the <code>EXPORTING</code> phase:</p>
<!-- test:assert=contains -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">[exporter] Adding layer &#39;examples/ruby:bundler&#39;
</code></pre></div><h2 id="caching-dependencies">Caching dependencies</h2>
<p>Now, let&rsquo;s implement the caching logic. We&rsquo;ll first need to create a <code>ruby-sample-app/Gemfile.lock</code> file with the contents given below:</p>
<blockquote>
<p>Typically you would run <code>bundle install</code> locally to generate this file, but for the sake
of simplicity we&rsquo;ll create <code>ruby-sample-app/Gemfile.lock</code> manually.</p>
</blockquote>
<!-- test:file=ruby-sample-app/Gemfile.lock -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">GEM
  remote: https://rubygems.org/
  specs:
    mustermann (1.0.3)
    rack (2.0.7)
    rack-protection (2.0.7)
      rack
    sinatra (2.0.7)
      mustermann (~&gt; 1.0)
      rack (~&gt; 2.0)
      rack-protection (= 2.0.7)
      tilt (~&gt; 2.0)
    tilt (2.0.9)

PLATFORMS
  ruby

DEPENDENCIES
  sinatra

BUNDLED WITH
   2.0.2
</code></pre></div><p>Replace the gem installation logic from the previous step:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># ...</span>

<span class="nb">echo</span> <span class="s2">&#34;---&gt; Installing gems&#34;</span>
<span class="nv">bundlerlayer</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler&#34;</span>
mkdir -p <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span>
<span class="nb">echo</span> -e <span class="s1">&#39;[types]\ncache = true\nlaunch = true&#39;</span> &gt; <span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler.toml&#34;</span>
bundle config <span class="nb">set</span> --local path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> bundle install <span class="o">&amp;&amp;</span> bundle binstubs --all --path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">/bin&#34;</span>


<span class="c1"># ...</span>
</code></pre></div><p>with the new logic below that checks to see if any gems have been changed. This simply creates a checksum for the previous <code>Gemfile.lock</code> and compares it to the checksum of the current <code>Gemfile.lock</code>. If they are the same, the gems are reused. If they are not, the new gems are installed.</p>
<p>We&rsquo;ll now write additional metadata to our <code>bundler.toml</code> of the form <code>cache = true</code> and <code>launch = true</code>. This directs the lifecycle to cache our gems and provide them when launching our application. With <code>cache = true</code> the lifecycle can keep existing gems around so that build times are fast, even with minor <code>Gemfile.lock</code> changes.</p>
<p>Note that there may be times when you would want to clean the cached layer from the previous build, in which case you should always ensure to remove the contents of the layer before proceeding with the build. In the case below this can be done using a simple <code>rm -rf &quot;$bundlerlayer&quot;/*</code> after the <code>mkdir -p &quot;$bundlerlayer&quot;</code> command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Compares previous Gemfile.lock checksum to the current Gemfile.lock</span>
<span class="nv">bundlerlayer</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler&#34;</span>
<span class="nv">local_bundler_checksum</span><span class="o">=</span><span class="k">$((</span>sha256sum Gemfile.lock &gt;/dev/null <span class="m">2</span>&gt;<span class="o">&amp;</span><span class="m">1</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s1">&#39;DOES_NOT_EXIST&#39;</span><span class="o">)</span> <span class="o">|</span> cut <span class="o">-</span>d <span class="s1">&#39; &#39;</span> <span class="o">-</span>f <span class="m">1</span><span class="o">)</span>
<span class="nv">remote_bundler_checksum</span><span class="o">=</span><span class="k">$(</span>cat <span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler.toml&#34;</span> <span class="p">|</span> yj -t <span class="p">|</span> jq -r .metadata.checksum 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo</span> <span class="s1">&#39;DOES_NOT_EXIST&#39;</span><span class="k">)</span>

<span class="k">if</span> <span class="o">[[</span> <span class="o">-</span>f Gemfile.lock <span class="o">&amp;&amp;</span> <span class="nv">$local_bundler_checksum</span> <span class="o">==</span> <span class="nv">$remote_bundler_checksum</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c1"># Determine if no gem dependencies have changed, so it can reuse existing gems without running bundle install</span>
    <span class="nb">echo</span> <span class="s2">&#34;---&gt; Reusing gems&#34;</span>
    bundle config <span class="o">--</span><span class="nb">local</span> path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span> &gt;/dev/null
    bundle config <span class="o">--</span><span class="nb">local</span> bin <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">/bin&#34;</span> &gt;/dev/null
<span class="k">else</span>
    <span class="c1"># Determine if there has been a gem dependency change and install new gems to the bundler layer; re-using existing and un-changed gems</span>
    <span class="nb">echo</span> <span class="s2">&#34;---&gt; Installing gems&#34;</span>
    mkdir <span class="o">-</span>p <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span>
    cat &gt; <span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler.toml&#34;</span> <span class="s">&lt;&lt;EOL
</span><span class="s">[types]
</span><span class="s">cache = true
</span><span class="s">launch = true
</span><span class="s">
</span><span class="s">[metadata]
</span><span class="s">checksum = &#34;$local_bundler_checksum&#34;
</span><span class="s">EOL</span>
    bundle config <span class="nb">set</span> <span class="o">--</span><span class="nb">local</span> path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> bundle install <span class="o">&amp;&amp;</span> bundle binstubs <span class="o">--</span>all <span class="o">--</span>path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">/bin&#34;</span>

<span class="k">fi</span>
</code></pre></div><p>Your full <code>ruby-buildpack/bin/build</code> script will now look like this:</p>
<!-- test:file=ruby-buildpack/bin/build -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/usr/bin/env bash
</span><span class="cp"></span><span class="nb">set</span> -eo pipefail

<span class="nb">echo</span> <span class="s2">&#34;---&gt; Ruby Buildpack&#34;</span>

<span class="c1"># 1. GET ARGS</span>
<span class="nv">layersdir</span><span class="o">=</span><span class="nv">$1</span>

<span class="c1"># 2. CREATE THE LAYER DIRECTORY</span>
<span class="nv">rubylayer</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">&#34;</span>/ruby
mkdir -p <span class="s2">&#34;</span><span class="nv">$rubylayer</span><span class="s2">&#34;</span>

<span class="c1"># 3. DOWNLOAD RUBY</span>
<span class="nb">echo</span> <span class="s2">&#34;---&gt; Downloading and extracting Ruby&#34;</span>
<span class="nv">ruby_url</span><span class="o">=</span>https://s3-external-1.amazonaws.com/heroku-buildpack-ruby/heroku-18/ruby-2.5.1.tgz
wget -q -O - <span class="s2">&#34;</span><span class="nv">$ruby_url</span><span class="s2">&#34;</span> <span class="p">|</span> tar -xzf - -C <span class="s2">&#34;</span><span class="nv">$rubylayer</span><span class="s2">&#34;</span>

<span class="c1"># 4. MAKE RUBY AVAILABLE DURING LAUNCH</span>
<span class="nb">echo</span> -e <span class="s1">&#39;[types]\nlaunch = true&#39;</span> &gt; <span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/ruby.toml&#34;</span>

<span class="c1"># 5. MAKE RUBY AVAILABLE TO THIS SCRIPT</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$rubylayer</span><span class="s2">&#34;</span>/bin:<span class="nv">$PATH</span>
<span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">LD_LIBRARY_PATH</span><span class="p">:+</span><span class="si">${</span><span class="nv">LD_LIBRARY_PATH</span><span class="si">}</span><span class="p">:</span><span class="si">}</span><span class="s2">&#34;</span><span class="nv">$rubylayer</span><span class="s2">/lib&#34;</span>

<span class="c1"># 6. INSTALL BUNDLER</span>
<span class="nb">echo</span> <span class="s2">&#34;---&gt; Installing bundler&#34;</span>
gem install bundler --no-ri --no-rdoc

<span class="c1"># ======= MODIFIED =======</span>
<span class="c1"># 7. INSTALL GEMS</span>
<span class="c1"># Compares previous Gemfile.lock checksum to the current Gemfile.lock</span>
<span class="nv">bundlerlayer</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler&#34;</span>
<span class="nv">local_bundler_checksum</span><span class="o">=</span><span class="k">$((</span>sha256sum Gemfile.lock &gt;/dev/null <span class="m">2</span>&gt;<span class="o">&amp;</span><span class="m">1</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s1">&#39;DOES_NOT_EXIST&#39;</span><span class="o">)</span> <span class="o">|</span> cut <span class="o">-</span>d <span class="s1">&#39; &#39;</span> <span class="o">-</span>f <span class="m">1</span><span class="o">)</span>
<span class="nv">remote_bundler_checksum</span><span class="o">=</span><span class="k">$(</span>cat <span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler.toml&#34;</span> <span class="p">|</span> yj -t <span class="p">|</span> jq -r .metadata.checksum 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo</span> <span class="s1">&#39;DOES_NOT_EXIST&#39;</span><span class="k">)</span>

<span class="k">if</span> <span class="o">[[</span> <span class="o">-</span>f Gemfile.lock <span class="o">&amp;&amp;</span> <span class="nv">$local_bundler_checksum</span> <span class="o">==</span> <span class="nv">$remote_bundler_checksum</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c1"># Determine if no gem dependencies have changed, so it can reuse existing gems without running bundle install</span>
    <span class="nb">echo</span> <span class="s2">&#34;---&gt; Reusing gems&#34;</span>
    bundle config <span class="o">--</span><span class="nb">local</span> path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span> &gt;/dev/null
    bundle config <span class="o">--</span><span class="nb">local</span> bin <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">/bin&#34;</span> &gt;/dev/null
<span class="k">else</span>
    <span class="c1"># Determine if there has been a gem dependency change and install new gems to the bundler layer; re-using existing and un-changed gems</span>
    <span class="nb">echo</span> <span class="s2">&#34;---&gt; Installing gems&#34;</span>
    mkdir <span class="o">-</span>p <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span>
    cat &gt; <span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/bundler.toml&#34;</span> <span class="s">&lt;&lt;EOL
</span><span class="s">[types]
</span><span class="s">cache = true
</span><span class="s">launch = true
</span><span class="s">
</span><span class="s">[metadata]
</span><span class="s">checksum = &#34;$local_bundler_checksum&#34;
</span><span class="s">EOL</span>
    bundle config <span class="nb">set</span> <span class="o">--</span><span class="nb">local</span> path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> bundle install <span class="o">&amp;&amp;</span> bundle binstubs <span class="o">--</span>all <span class="o">--</span>path <span class="s2">&#34;</span><span class="nv">$bundlerlayer</span><span class="s2">/bin&#34;</span>

<span class="k">fi</span>

<span class="c1"># 8. SET DEFAULT START COMMAND</span>
cat &gt; <span class="s2">&#34;</span><span class="nv">$layersdir</span><span class="s2">/launch.toml&#34;</span> <span class="s">&lt;&lt;EOL
</span><span class="s"># our web process
</span><span class="s">[[processes]]
</span><span class="s">type = &#34;web&#34;
</span><span class="s">command = &#34;bundle exec ruby app.rb&#34;
</span><span class="s">default = true
</span><span class="s">
</span><span class="s"># our worker process
</span><span class="s">[[processes]]
</span><span class="s">type = &#34;worker&#34;
</span><span class="s">command = &#34;bundle exec ruby worker.rb&#34;
</span><span class="s">EOL</span>
</code></pre></div><p>Now when you build your app:</p>
<!-- test:exec -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">pack build test-ruby-app --path ./ruby-sample-app --buildpack ./ruby-buildpack
</code></pre></div><p>it will download the gems:</p>
<!-- test:assert=contains;ignore-lines=... -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">===&gt; BUILDING
[builder] ---&gt; Ruby Buildpack
[builder] ---&gt; Downloading and extracting Ruby
[builder] ---&gt; Installing bundler
...
[builder] ---&gt; Installing gems
</code></pre></div><p>If you build the app again:</p>
<!-- test:exec -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">pack build test-ruby-app --path ./ruby-sample-app --buildpack ./ruby-buildpack
</code></pre></div><p>you will see the new caching logic at work during the <code>BUILDING</code> phase:</p>
<!-- test:assert=contains;ignore-lines=... -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">===&gt; BUILDING
[builder] ---&gt; Ruby Buildpack
[builder] ---&gt; Downloading and extracting Ruby
[builder] ---&gt; Installing bundler
...
[builder] ---&gt; Reusing gems
</code></pre></div><p>Next, let&rsquo;s see how buildpack users may be able to provide configuration to the buildpack.</p>
<hr>
<p><a href="/docs/buildpack-author-guide/create-buildpack/make-buildpack-configurable" class="button bg-pink">Next Step</a></p>


        

        <hr>
<div class='footline d-block'>
  <div class="support-links text-right">
  
    
    
    <a href="https://github.com/buildpacks/docs/issues/new?body=%2A%2AOn&#43;Page%3A%2A%2A&#43;%5BImproving&#43;performance&#43;with&#43;caching%5D%28https%3A%2F%2Fbuildpacks.io%2Fdocs%2Fbuildpack-author-guide%2Fcreate-buildpack%2Fcaching%2F%29"
       class="button-light button-small icon-button blank bg-white inline-flex" target="_blank">Report Issue</a>

    
    
    <a href="https://github.com/buildpacks/docs/edit/main/content/docs/buildpack-author-guide/create-buildpack/caching.md?description=Signed-off-by%3A&#43;NAME&#43;%3CEMAIL_ADDRESS%3E%0A%0A%3E&#43;_By&#43;signing&#43;off&#43;you&#43;acknowledge&#43;adhering&#43;to&#43;the&#43;requirements&#43;listed&#43;here%3A&#43;https%3A%2F%2Fprobot.github.io%2Fapps%2Fdco%2F_"
       class="button-light button-small icon-button github-button bg-white inline-flex" target="_blank">Edit</a>
    
  
</div>

</div>

      </div>
    </div>
  </div>
</div>





  <footer>
  <div class="container footer">
    <a href="https://www.cncf.io/" style="width: 50%;"><img src="/images/cncf-color.svg" class="footer-logo" alt="CNCF logo" ></a>
    <p>We are a <a href="https://www.cncf.io/">Cloud Native Computing Foundation</a> incubating project.</p>
  </div>
  <div class="bg-blue">
    <div class="container sub-footer">
      <ul>
        
        <li><a target="_blank" rel="noopener noreferrer" href="https://buildpacks.devstats.cncf.io/d/8/dashboards?orgId=1&amp;refresh=15m">DevStats</a></li>
        
        <li><span>&bull;</span><a target="_blank" rel="noopener noreferrer" href="https://datastudio.google.com/reporting/4b23856c-6c24-44f5-86f2-333d0ad3f236">Analytics</a></li>
        
        <li><span>&bull;</span><a target="_blank" rel="noopener noreferrer" href="https://www.linuxfoundation.org/privacy/">Privacy Policy</a></li>
        
      </ul>

      <ul>
        
        <li><a target="_blank" rel="noopener noreferrer" href="https://lists.cncf.io/g/cncf-buildpacks/join">Mailing List</a></li>
        
        <li><span>&bull;</span><a target="_blank" rel="noopener noreferrer" href="https://slack.buildpacks.io/">Slack</a></li>
        
        <li><span>&bull;</span><a target="_blank" rel="noopener noreferrer" href="https://twitter.com/buildpacks_io">Twitter</a></li>
        
        <li><span>&bull;</span><a target="_blank" rel="noopener noreferrer" href="https://github.com/buildpacks">GitHub</a></li>
        
      </ul>
    </div>
  </div>
</footer>

</body>

</html>